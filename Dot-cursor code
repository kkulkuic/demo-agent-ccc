import sys
from playwright.sync_api import sync_playwright, TimeoutError as PlaywrightTimeoutError

# Big visible dot overlay (always visible)
DOT_JS = r"""
(() => {
  const old = document.getElementById('__pw_dot');
  if (old) old.remove();

  const dot = document.createElement('div');
  dot.id = '__pw_dot';
  dot.style.cssText = `
    position: fixed;
    left: 200px; top: 200px;
    width: 18px; height: 18px;
    border-radius: 50%;
    background: red;
    z-index: 2147483647;
    pointer-events: none;
    transform: translate(-50%, -50%);
    box-shadow: 0 0 0 4px rgba(255,0,0,0.35), 0 0 14px rgba(255,0,0,0.85);
  `;
  document.documentElement.appendChild(dot);

  // follow any mouse movement inside the page
  window.addEventListener('mousemove', (e) => {
    dot.style.left = e.clientX + 'px';
    dot.style.top  = e.clientY + 'px';
  }, true);

  true;
})();
"""

def install_dot(page):
    page.evaluate(DOT_JS)
    page.evaluate("() => window.__pwDotMove && window.__pwDotMove(200, 200)")

def slow_drag(page, x0, y0, x1, y1, steps=120, delay_ms=5):
    dx = (x1 - x0) / steps
    dy = (y1 - y0) / steps
    for i in range(steps + 1):
        x = x0 + dx * i
        y = y0 + dy * i
        page.mouse.move(x, y, steps=1)
        if delay_ms:
            page.wait_for_timeout(delay_ms)

def main():
    url = sys.argv[1] if len(sys.argv) > 1 else "https://www.wikipedia.org"

    with sync_playwright() as p:
        browser = p.chromium.launch(headless=False, slow_mo=0)
        context = browser.new_context(viewport={"width": 1200, "height": 800})
        page = context.new_page()

        # Prove dot on blank page
        page.goto("about:blank")
        install_dot(page)
        page.wait_for_timeout(1200)

        # Navigate to site
        page.goto(url, wait_until="domcontentloaded")
        try:
            page.wait_for_load_state("networkidle", timeout=8000)
        except PlaywrightTimeoutError:
            pass

        install_dot(page)
        page.wait_for_timeout(800)

        # Slow drag demo
        x0, y0 = 200, 200
        path = [(900, 220), (900, 650), (250, 650), (250, 250), (800, 500)]
        for (x1, y1) in path:
            slow_drag(page, x0, y0, x1, y1, steps=100, delay_ms=5)
            x0, y0 = x1, y1

        page.wait_for_timeout(15000)
        browser.close()

if __name__ == "__main__":
    main()
